<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jamabandi PDF Reader + Analytics (Online-only)</title>

  <style>
    :root{
      --bg:#070b14; --panel:#0d1425; --card:#0f1b33; --border:#223458;
      --text:#e9eefc; --muted:#9fb0d0; --accent:#4cc9f0;
      --good:#27c58b; --warn:#ffcc66; --bad:#ff6b8b;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    h1{margin:10px 0 6px;font-size:28px}
    .sub{color:var(--muted);font-size:13px;margin-bottom:14px}
    .grid{display:grid;gap:14px}
    @media(min-width:980px){.grid{grid-template-columns: 420px 1fr; align-items:start}}
    .panel{background:linear-gradient(180deg,var(--panel),#081024);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 18px 55px rgba(0,0,0,.45)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{font-size:12px;color:var(--muted);display:block;margin:8px 0 6px}
    input,button,textarea{
      width:100%; border:1px solid var(--border); background:rgba(255,255,255,.04);
      color:var(--text); border-radius:12px; padding:12px; outline:none;
    }
    textarea{min-height:96px;resize:vertical}
    button{cursor:pointer;font-weight:700;letter-spacing:.2px}
    .btn{background:rgba(76,201,240,.12);border:1px solid rgba(76,201,240,.4)}
    .btn2{background:rgba(255,255,255,.06)}
    .btnDanger{background:rgba(255,107,139,.12);border:1px solid rgba(255,107,139,.4)}
    .pill{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);color:var(--muted)}
    .status{margin-top:10px;font-size:13px;color:var(--muted)}
    .status b{color:var(--text)}
    canvas{width:100%;background:#0b1227;border:1px solid var(--border);border-radius:14px}
    .viewerTop{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
    .viewerTop .pill{background:rgba(255,255,255,.03)}
    .small{font-size:12px;color:var(--muted)}
    .hr{height:1px;background:rgba(255,255,255,.06);margin:12px 0}
    .hit{background:rgba(255,204,102,.25);border:1px solid rgba(255,204,102,.35);padding:8px;border-radius:12px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  </style>

  <!-- ✅ ONLINE ONLY: PDF.js from CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    // ✅ worker from CDN
    window.addEventListener("load", () => {
      if (!window.pdfjsLib) {
        alert("PDF.js failed to load from internet. Please check connection.");
        return;
      }
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
    });
  </script>
</head>

<body>
  <div class="wrap">
    <h1>Jamabandi PDF Reader + Analytics</h1>
    <div class="sub">
      Online-only version: loads PDF.js via CDN. If internet is off, PDF won't load.
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="panel">
        <div class="row" style="justify-content:space-between">
          <div class="pill">NO index required</div>
          <div class="pill">Rules from Firebase RTDB</div>
        </div>

        <div class="hr"></div>

        <h3 style="margin:0 0 6px">Firebase RTDB Settings</h3>
        <div class="small">Loads rules with GET: <span class="mono">/BASE_PATH/nodes/1.json</span></div>

        <label>RTDB Base URL (no trailing slash)</label>
        <input id="rtdbUrl" value="https://revnue-records-default-rtdb.asia-southeast1.firebasedatabase.app" />

        <label>Base Path (folder only)</label>
        <input id="basePath" value="hp_landcode_2023_v3" />

        <label>Auth Token (optional)</label>
        <input id="token" placeholder="Paste token if required" />

        <label>Rules doc id (node id)</label>
        <input id="docId" value="1" />

        <div class="row" style="margin-top:10px">
          <button class="btn" id="btnLoadRules" style="flex:1">Load Rules</button>
          <button class="btn2" id="btnClearRules" style="flex:1">Clear</button>
        </div>

        <div id="rulesStatus" class="status">Rules: <b>not loaded</b></div>
        <textarea id="rulesBox" placeholder="Rules JSON will appear here"></textarea>

        <div class="hr"></div>

        <h3 style="margin:0 0 6px">PDF Reader</h3>
        <label>Load Jamabandi PDF</label>
        <input type="file" id="pdfFile" accept="application/pdf"/>

        <div class="row" style="margin-top:10px">
          <button class="btn" id="btnLoadPdf" style="flex:1">Load PDF</button>
          <button class="btnDanger" id="btnReset" style="flex:1">Reset</button>
        </div>

        <div id="pdfStatus" class="status">PDF: <b>not loaded</b></div>

        <label>Search within PDF text (text PDFs)</label>
        <input id="q" placeholder="e.g., khasra 1821, mutation, Narender, Kulvinder..." />

        <div class="row" style="margin-top:10px">
          <button class="btn2" id="btnSearch" style="flex:1">Search</button>
          <button class="btn2" id="btnClearSearch" style="flex:1">Clear</button>
        </div>

        <div id="searchInfo" class="status">Search: <b>idle</b></div>
        <div id="hits"></div>
      </div>

      <!-- RIGHT -->
      <div class="panel">
        <div class="viewerTop">
          <span class="pill">Viewer</span>
          <button class="btn2" id="btnPrev">◀ Prev</button>
          <button class="btn2" id="btnNext">Next ▶</button>
          <span class="pill">Page <b id="pageNow">-</b> / <b id="pageTotal">-</b></span>
          <input id="pageGo" type="number" min="1" placeholder="Go" style="width:110px"/>
          <button class="btn2" id="btnGo">Go</button>
          <span class="pill" id="libInfo">PDF.js: <b>cdn</b></span>
        </div>

        <canvas id="cv"></canvas>

        <div class="hr"></div>
        <div class="small">
          If the PDF is scanned (image-only), text extraction will be empty. OCR required for search.
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   Firebase RTDB rules loader
   ========================= */
const rtdbUrl = document.getElementById('rtdbUrl');
const basePath = document.getElementById('basePath');
const token   = document.getElementById('token');
const docId   = document.getElementById('docId');
const rulesBox = document.getElementById('rulesBox');
const rulesStatus = document.getElementById('rulesStatus');

document.getElementById('btnLoadRules').addEventListener('click', async ()=>{
  const base = rtdbUrl.value.trim().replace(/\/+$/,'');
  const path = basePath.value.trim().replace(/^\/+|\/+$/g,'');
  const id = docId.value.trim();
  if(!base || !path || !id){
    alert('Please fill RTDB Base URL, Base Path, and Rules doc id.');
    return;
  }
  const url = `${base}/${path}/nodes/${encodeURIComponent(id)}.json` +
    (token.value.trim()? `?auth=${encodeURIComponent(token.value.trim())}` : '');

  rulesStatus.innerHTML = 'Rules: <b>loading…</b>';
  try{
    const res = await fetch(url, {method:'GET'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();
    rulesBox.value = JSON.stringify(data, null, 2);
    rulesStatus.innerHTML = 'Rules: <b style="color:#27c58b">loaded</b>';
  }catch(err){
    rulesStatus.innerHTML = 'Rules: <b style="color:#ff6b8b">failed</b>';
    alert('Failed to load rules.\n'+err.message+'\n\nURL:\n'+url);
  }
});

document.getElementById('btnClearRules').addEventListener('click', ()=>{
  rulesBox.value='';
  rulesStatus.innerHTML = 'Rules: <b>not loaded</b>';
});

/* =========================
   PDF viewer + search
   ========================= */
const pdfFile = document.getElementById('pdfFile');
const pdfStatus = document.getElementById('pdfStatus');
const cv = document.getElementById('cv');
const ctx = cv.getContext('2d');
const pageNowEl = document.getElementById('pageNow');
const pageTotalEl = document.getElementById('pageTotal');

let pdfDoc = null;
let currentPage = 1;
let pageTextCache = new Map();

function setPdfStatus(txt, color){
  pdfStatus.innerHTML = `PDF: <b style="color:${color||'#e9eefc'}">${txt}</b>`;
}

async function renderPage(n){
  if(!pdfDoc) return;
  currentPage = Math.max(1, Math.min(n, pdfDoc.numPages));
  const page = await pdfDoc.getPage(currentPage);
  const viewport = page.getViewport({ scale: 1.35 });

  cv.width = Math.floor(viewport.width);
  cv.height = Math.floor(viewport.height);

  await page.render({ canvasContext: ctx, viewport }).promise;

  pageNowEl.textContent = String(currentPage);
  pageTotalEl.textContent = String(pdfDoc.numPages);

  try{
    const textContent = await page.getTextContent();
    const text = textContent.items.map(it=>it.str).join(' ').replace(/\s+/g,' ').trim();
    pageTextCache.set(currentPage, text);
  }catch(e){
    pageTextCache.set(currentPage, '');
  }
}

document.getElementById('btnLoadPdf').addEventListener('click', async ()=>{
  try{
    if(!window.pdfjsLib){
      alert("PDF.js not loaded. Check internet connection.");
      return;
    }
    const f = pdfFile.files?.[0];
    if(!f){ alert('Please choose a PDF first.'); return; }

    setPdfStatus('loading…', '#ffcc66');
    const buf = await f.arrayBuffer();
    pdfDoc = await pdfjsLib.getDocument({ data: buf }).promise;

    pageTextCache.clear();
    currentPage = 1;

    setPdfStatus('loaded (' + pdfDoc.numPages + ' pages)', '#27c58b');
    await renderPage(1);
  }catch(err){
    setPdfStatus('failed', '#ff6b8b');
    alert('PDF failed to load: ' + err.message);
  }
});

document.getElementById('btnReset').addEventListener('click', ()=>{
  pdfDoc = null;
  currentPage = 1;
  pageTextCache.clear();
  ctx.clearRect(0,0,cv.width,cv.height);
  pageNowEl.textContent='-';
  pageTotalEl.textContent='-';
  setPdfStatus('not loaded');
  document.getElementById('hits').innerHTML='';
  document.getElementById('searchInfo').innerHTML='Search: <b>idle</b>';
});

document.getElementById('btnPrev').addEventListener('click', ()=> renderPage(currentPage-1));
document.getElementById('btnNext').addEventListener('click', ()=> renderPage(currentPage+1));
document.getElementById('btnGo').addEventListener('click', ()=>{
  const v = parseInt(document.getElementById('pageGo').value,10);
  if(Number.isFinite(v)) renderPage(v);
});

const searchInfo = document.getElementById('searchInfo');
const hitsBox = document.getElementById('hits');

function escHtml(s){ return s.replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }

document.getElementById('btnSearch').addEventListener('click', async ()=>{
  if(!pdfDoc){ alert('Load a PDF first.'); return; }
  const q = document.getElementById('q').value.trim();
  if(!q){ alert('Enter search text.'); return; }

  searchInfo.innerHTML = 'Search: <b>scanning…</b>';
  hitsBox.innerHTML = '';

  const qLow = q.toLowerCase();
  let totalHits = 0;

  for(let p=1;p<=pdfDoc.numPages;p++){
    if(!pageTextCache.has(p)){
      try{
        const page = await pdfDoc.getPage(p);
        const textContent = await page.getTextContent();
        const text = textContent.items.map(it=>it.str).join(' ').replace(/\s+/g,' ').trim();
        pageTextCache.set(p, text);
      }catch(e){
        pageTextCache.set(p, '');
      }
    }
    const t = pageTextCache.get(p) || '';
    const idx = t.toLowerCase().indexOf(qLow);
    if(idx !== -1){
      totalHits++;
      const start = Math.max(0, idx - 80);
      const end = Math.min(t.length, idx + q.length + 80);
      const snippet = t.slice(start, end);

      const re = new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'ig');
      const html = escHtml(snippet).replace(re, m=>`<mark style="background:rgba(255,204,102,.35);color:inherit;border-radius:6px;padding:0 3px">${escHtml(m)}</mark>`);

      const div = document.createElement('div');
      div.className='hit';
      div.style.marginTop='10px';
      div.innerHTML = `<div class="small">Page <b>${p}</b></div><div>${html}</div>`;
      div.addEventListener('click', ()=>renderPage(p));
      hitsBox.appendChild(div);
    }
  }

  searchInfo.innerHTML = totalHits
    ? `Search: <b style="color:#27c58b">${totalHits} page(s) matched</b> (tap result to open)`
    : 'Search: <b style="color:#ff6b8b">no matches</b>';
});

document.getElementById('btnClearSearch').addEventListener('click', ()=>{
  document.getElementById('q').value='';
  hitsBox.innerHTML='';
  searchInfo.innerHTML='Search: <b>idle</b>';
});
</script>

</body>
</html>
