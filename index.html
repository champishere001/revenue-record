<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bhunaksha-Style Khasra Map (Google Maps Base)</title>
  <style>
    :root{
      --bg:#070b14; --panel:#0d1425; --card:#0f1b33; --border:#223458;
      --text:#e9eefc; --muted:#9fb0d0; --accent:#4cc9f0; --good:#27c58b; --warn:#ffcc66; --bad:#ff6b8b;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    #map{width:100vw;height:100vh}

    /* Top left control panel */
    .hud{
      position:absolute; left:12px; top:12px; z-index:10;
      width:min(420px, calc(100vw - 24px));
      background:rgba(7,11,20,.78);
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      backdrop-filter: blur(10px);
      box-shadow:0 18px 40px rgba(0,0,0,.35);
    }
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .title{display:flex; align-items:center; gap:10px; margin-bottom:8px}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 18px rgba(76,201,240,.55)}
    h1{font-size:14px;margin:0}
    .sub{font-size:12px;color:var(--muted);margin:4px 0 10px;line-height:1.35}

    input, button, select{
      font:inherit;
    }
    input{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#091127;
      color:var(--text);
      outline:none;
    }
    .btn{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#0b1530;
      color:var(--text);
      cursor:pointer;
      font-weight:700;
      transition:.15s transform,.15s opacity;
      user-select:none;
    }
    .btn:hover{opacity:.95;transform:translateY(-1px)}
    .btn.primary{background:linear-gradient(135deg,rgba(76,201,240,.22),rgba(76,201,240,.06));border-color:rgba(76,201,240,.55)}
    .btn.good{background:linear-gradient(135deg,rgba(39,197,139,.22),rgba(39,197,139,.06));border-color:rgba(39,197,139,.55)}
    .btn.warn{background:linear-gradient(135deg,rgba(255,204,102,.22),rgba(255,204,102,.06));border-color:rgba(255,204,102,.58)}
    .btn.bad{background:linear-gradient(135deg,rgba(255,107,139,.22),rgba(255,107,139,.06));border-color:rgba(255,107,139,.58)}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}

    .hint{font-size:12px;color:var(--muted);margin-top:10px;line-height:1.35}
    .pill{
      display:inline-flex;gap:8px;align-items:center;
      padding:6px 10px;border-radius:999px;border:1px solid var(--border);
      background:rgba(255,255,255,.03);font-size:12px;color:var(--muted)
    }
    .statusDot{width:8px;height:8px;border-radius:50%}
    .ok{background:var(--good)}
    .no{background:var(--bad)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}

    /* Bottom-right plot info panel (Bhunaksha-style) */
    .plotInfo{
      position:absolute; right:12px; bottom:12px; z-index:10;
      width:min(430px, calc(100vw - 24px));
      max-height:48vh;
      overflow:auto;
      background:rgba(7,11,20,.86);
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      backdrop-filter: blur(10px);
      box-shadow:0 18px 40px rgba(0,0,0,.35);
    }
    .plotInfoHead{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      margin-bottom:8px;
    }
    .plotInfo h2{margin:0;font-size:14px}
    .kv{
      margin-top:8px;
      border:1px solid rgba(34,52,88,.75);
      border-radius:12px;
      overflow:hidden;
    }
    .kvRow{
      display:grid;
      grid-template-columns:140px 1fr;
      gap:10px;
      padding:8px 10px;
      border-bottom:1px solid rgba(34,52,88,.55);
      font-size:12px;
    }
    .kvRow:last-child{border-bottom:none}
    .k{color:var(--muted)}
    .v{color:var(--text);word-break:break-word}
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(76,201,240,.55);
      background:rgba(76,201,240,.08);
      font-size:12px;color:var(--text);
      white-space:nowrap;
    }
    .closeX{
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      border-radius:10px;
      padding:6px 10px;
      cursor:pointer;
      font-weight:800;
    }

    /* Small footer label */
    .credit{
      position:absolute; left:12px; bottom:12px; z-index:10;
      color:rgba(233,238,252,.75);
      font-size:11px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(7,11,20,.55);
      border:1px solid rgba(34,52,88,.55);
      backdrop-filter: blur(10px);
    }
    a{color:var(--accent);text-decoration:none}
  </style>
</head>
<body>

<div id="map"></div>

<!-- Top-left panel -->
<div class="hud">
  <div class="title">
    <span class="dot"></span>
    <div>
      <h1>Bhunaksha-style “Khasra Map” (Google Maps base)</h1>
      <div class="sub">Load your khasra boundaries (GeoJSON) + details (CSV). Search by khasra → zoom + highlight → show Plot Info in bottom-right.</div>
    </div>
  </div>

  <div class="grid2" style="margin-bottom:10px">
    <div>
      <label style="font-size:12px;color:var(--muted);display:block;margin:0 0 6px">Khasra No (search)</label>
      <input id="khasraSearch" placeholder="e.g., 1228" />
    </div>
    <div>
      <label style="font-size:12px;color:var(--muted);display:block;margin:0 0 6px">Quick actions</label>
      <div class="row">
        <button class="btn primary" id="btnFind">Find</button>
        <button class="btn" id="btnClearSel">Clear</button>
      </div>
    </div>
  </div>

  <div class="grid2">
    <button class="btn good" id="btnLoadGeoJSON">Load Boundaries (GeoJSON)</button>
    <button class="btn good" id="btnLoadCSV">Load Details (CSV)</button>
  </div>

  <div class="row" style="margin-top:10px">
    <span class="pill"><span class="statusDot no" id="bDot"></span> Boundaries: <b id="bState">not loaded</b></span>
    <span class="pill"><span class="statusDot no" id="dDot"></span> Details: <b id="dState">not loaded</b></span>
  </div>

  <div class="hint">
    <b>Data formats:</b><br/>
    1) GeoJSON: each feature must have <span class="mono">properties.khasra</span> (or <span class="mono">khasra_no</span>).<br/>
    2) CSV headers (any order): <span class="mono">khasra,owner,area,village,tehsil,district</span> (minimum: <span class="mono">khasra</span>).<br/>
    <span style="opacity:.9">Tip:</span> Click any polygon on the map to open Plot Info.
  </div>
</div>

<!-- Bottom-right plot info -->
<div class="plotInfo" id="plotInfo" style="display:none">
  <div class="plotInfoHead">
    <div>
      <h2 id="piTitle">Plot Info</h2>
      <div class="sub" id="piSub" style="margin:4px 0 0">—</div>
    </div>
    <button class="closeX" id="piClose">✕</button>
  </div>

  <div class="row" style="margin:8px 0 10px">
    <span class="badge" id="piBadge">Khasra: —</span>
    <span class="pill">Source: <b>Your data</b></span>
  </div>

  <div class="kv" id="piKV"></div>

  <div class="hint" style="margin-top:10px">
    If you want the exact Bhunaksha-like “right-bottom table”, just keep the CSV columns you like — the panel will show them automatically.
  </div>
</div>

<div class="credit">
  Base map: Google Maps • Khasra layer: GeoJSON • Details: CSV • Built for village khasra mapping
</div>

<script>
/**
 * IMPORTANT:
 * You must add your Google Maps JS API key in the script tag at the bottom:
 *   https://maps.googleapis.com/maps/api/js?key=YOUR_KEY&callback=initMap
 * 
 * This page DOES NOT connect to Bhunaksha portal. It is a Bhunaksha-LIKE interface over Google base,
 * using YOUR own khasra boundaries + details.
 */

let map;
let dataLayer;                 // google.maps.Data
let boundariesLoaded = false;
let detailsLoaded = false;

const featuresByKhasra = new Map();  // khasra -> google.maps.Data.Feature
const detailsByKhasra  = new Map();  // khasra -> {col:val,...}

let selectedFeature = null;

const el = (id)=>document.getElementById(id);

function setState(which, ok, text){
  if(which === "b"){
    el("bState").textContent = text;
    el("bDot").className = "statusDot " + (ok ? "ok":"no");
  }else{
    el("dState").textContent = text;
    el("dDot").className = "statusDot " + (ok ? "ok":"no");
  }
}

function normalizeKhasra(v){
  return (v ?? "").toString().trim();
}

function initMap(){
  map = new google.maps.Map(document.getElementById("map"), {
    center: {lat: 31.1048, lng: 77.1734}, // Shimla-ish default; you can change
    zoom: 11,
    mapTypeId: "roadmap",
    streetViewControl: false,
    fullscreenControl: true
  });

  dataLayer = new google.maps.Data({ map });

  // Default style
  dataLayer.setStyle((feature) => {
    const isSelected = selectedFeature && feature.getId && (feature.getId() === selectedFeature.getId());
    return {
      fillColor: isSelected ? "#4cc9f0" : "#4cc9f0",
      fillOpacity: isSelected ? 0.28 : 0.12,
      strokeColor: isSelected ? "#ffcc66" : "#4cc9f0",
      strokeOpacity: 0.95,
      strokeWeight: isSelected ? 3 : 2,
      clickable: true,
      zIndex: isSelected ? 999 : 1
    };
  });

  // Click polygon → select + show plot info
  dataLayer.addListener("click", (e) => {
    const f = e.feature;
    selectFeature(f, { panTo: true, fit: true });
  });

  // UI wires
  el("btnLoadGeoJSON").addEventListener("click", loadGeoJSONFromFile);
  el("btnLoadCSV").addEventListener("click", loadCSVFromFile);
  el("btnFind").addEventListener("click", () => findKhasra(el("khasraSearch").value));
  el("btnClearSel").addEventListener("click", clearSelection);
  el("khasraSearch").addEventListener("keydown", (ev) => {
    if(ev.key === "Enter") findKhasra(el("khasraSearch").value);
  });

  el("piClose").addEventListener("click", () => {
    el("plotInfo").style.display = "none";
  });

  // Helpful start
  setState("b", false, "not loaded");
  setState("d", false, "not loaded");
}

/* ===========================
   Loading Boundaries (GeoJSON)
   =========================== */

function loadGeoJSONFromFile(){
  const inp = document.createElement("input");
  inp.type = "file";
  inp.accept = ".geojson,.json,application/geo+json,application/json";
  inp.onchange = async () => {
    const file = inp.files && inp.files[0];
    if(!file) return;

    try{
      const text = await file.text();
      const gj = JSON.parse(text);

      // Reset existing
      featuresByKhasra.clear();
      clearSelection();
      dataLayer.forEach((f)=>dataLayer.remove(f));

      // Add
      dataLayer.addGeoJson(gj);

      // Index features by khasra
      dataLayer.forEach((f) => {
        // Try multiple property names
        const p = f.getProperty("khasra")
               ?? f.getProperty("khasra_no")
               ?? f.getProperty("Khasra")
               ?? f.getProperty("KHASRA")
               ?? f.getProperty("plot")
               ?? "";

        const khasra = normalizeKhasra(p);
        if(!khasra) return;

        // Give stable ID for selection comparison
        try{ f.setId(khasra); }catch(_){ /* ignore */ }
        featuresByKhasra.set(khasra, f);
      });

      boundariesLoaded = featuresByKhasra.size > 0;
      setState("b", boundariesLoaded, boundariesLoaded ? `${featuresByKhasra.size} plots` : "loaded (no khasra property found)");

      // Auto fit all
      if(boundariesLoaded){
        const bounds = new google.maps.LatLngBounds();
        dataLayer.forEach((f) => {
          f.getGeometry().forEachLatLng((latlng) => bounds.extend(latlng));
        });
        map.fitBounds(bounds, 40);
      }

      alert(boundariesLoaded
        ? `Boundaries loaded ✅ (${featuresByKhasra.size} khasra features indexed)`
        : `GeoJSON loaded, but khasra property not found. Ensure each feature has properties.khasra (or khasra_no).`);
    }catch(e){
      console.error(e);
      alert("Failed to load GeoJSON. Please check file format.");
    }
  };
  inp.click();
}

/* ======================
   Loading Details (CSV)
   ====================== */

function loadCSVFromFile(){
  const inp = document.createElement("input");
  inp.type = "file";
  inp.accept = ".csv,text/csv";
  inp.onchange = async () => {
    const file = inp.files && inp.files[0];
    if(!file) return;

    try{
      const text = await file.text();
      const parsed = parseCSV(text);

      if(!parsed.headers.length){
        alert("CSV looks empty.");
        return;
      }

      // Find khasra column name
      const khasraCol = findHeader(parsed.headers, ["khasra","khasra_no","plot","plot_no","khasra number","khasra number."]);
      if(!khasraCol){
        alert("CSV must include a khasra column (khasra / khasra_no / plot).");
        return;
      }

      detailsByKhasra.clear();

      for(const row of parsed.rows){
        const khasra = normalizeKhasra(row[khasraCol]);
        if(!khasra) continue;

        // Keep all columns
        detailsByKhasra.set(khasra, row);
      }

      detailsLoaded = detailsByKhasra.size > 0;
      setState("d", detailsLoaded, detailsLoaded ? `${detailsByKhasra.size} rows` : "loaded (0 rows)");
      alert(detailsLoaded ? `Details loaded ✅ (${detailsByKhasra.size} khasra rows)` : "Details loaded, but no usable rows found.");
    }catch(e){
      console.error(e);
      alert("Failed to load CSV. Please check formatting (comma-separated, header row).");
    }
  };
  inp.click();
}

function findHeader(headers, candidates){
  const lower = headers.map(h => h.toLowerCase().trim());
  for(const c of candidates){
    const idx = lower.indexOf(c.toLowerCase().trim());
    if(idx >= 0) return headers[idx];
  }
  // fallback: contains
  for(const c of candidates){
    const idx = lower.findIndex(h => h.includes(c.toLowerCase().trim()));
    if(idx >= 0) return headers[idx];
  }
  return null;
}

// Minimal CSV parser that handles quotes
function parseCSV(text){
  const lines = text.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n").filter(l => l.trim().length);
  if(!lines.length) return {headers:[], rows:[]};

  const headers = splitCSVLine(lines[0]).map(h => h.trim());
  const rows = [];

  for(let i=1;i<lines.length;i++){
    const cols = splitCSVLine(lines[i]);
    const row = {};
    headers.forEach((h, idx) => row[h] = (cols[idx] ?? "").trim());
    rows.push(row);
  }
  return {headers, rows};
}

function splitCSVLine(line){
  const out = [];
  let cur = "";
  let inQ = false;
  for(let i=0;i<line.length;i++){
    const ch = line[i];
    if(ch === '"'){
      if(inQ && line[i+1] === '"'){ // escaped quote
        cur += '"'; i++;
      }else{
        inQ = !inQ;
      }
    }else if(ch === "," && !inQ){
      out.push(cur); cur = "";
    }else{
      cur += ch;
    }
  }
  out.push(cur);
  return out;
}

/* ==========================
   Find / Select / Plot Info
   ========================== */

function findKhasra(khasraInput){
  const khasra = normalizeKhasra(khasraInput);
  if(!khasra){
    alert("Enter a khasra number.");
    return;
  }
  if(!boundariesLoaded){
    alert("Load boundaries (GeoJSON) first.");
    return;
  }
  const f = featuresByKhasra.get(khasra);
  if(!f){
    alert(`Khasra not found: ${khasra}\nCheck if GeoJSON feature has properties.khasra exactly matching your search.`);
    return;
  }
  selectFeature(f, { panTo: true, fit: true });
}

function clearSelection(){
  selectedFeature = null;
  dataLayer.revertStyle();
  // Hide plot info
  el("plotInfo").style.display = "none";
}

function selectFeature(feature, opts={panTo:true, fit:true}){
  selectedFeature = feature;
  dataLayer.revertStyle();
  dataLayer.overrideStyle(feature, {
    fillOpacity: 0.30,
    strokeColor: "#ffcc66",
    strokeWeight: 3,
    zIndex: 999
  });

  // Fit bounds of the feature
  if(opts.fit){
    const bounds = new google.maps.LatLngBounds();
    feature.getGeometry().forEachLatLng((latlng) => bounds.extend(latlng));
    map.fitBounds(bounds, 60);
  }

  if(opts.panTo){
    const c = getFeatureCentroid(feature);
    if(c) map.panTo(c);
  }

  // Khasra id
  const khasra = normalizeKhasra(feature.getProperty("khasra") ?? feature.getProperty("khasra_no") ?? feature.getId() ?? "");

  // Plot info panel
  showPlotInfo(khasra, feature);
}

function getFeatureCentroid(feature){
  // Simple centroid approximation by averaging vertices
  let sumLat = 0, sumLng = 0, count = 0;
  feature.getGeometry().forEachLatLng((latlng) => {
    sumLat += latlng.lat();
    sumLng += latlng.lng();
    count++;
  });
  if(!count) return null;
  return { lat: sumLat / count, lng: sumLng / count };
}

function showPlotInfo(khasra, feature){
  el("plotInfo").style.display = "block";
  el("piTitle").textContent = "Plot Info";
  el("piSub").textContent = "Selected polygon on map";
  el("piBadge").textContent = `Khasra: ${khasra || "—"}`;

  const kv = el("piKV");
  kv.innerHTML = "";

  // Compose fields:
  // 1) Prefer details CSV row (if present)
  // 2) Also include feature properties
  const details = detailsByKhasra.get(khasra) || null;

  const out = {};
  if(details){
    Object.assign(out, details);
  }

  // Add any missing from feature properties
  // (Google Data exposes properties via getProperty, but we don't know keys, so we try common ones)
  const commonKeys = ["owner","owners","area","village","tehsil","district","halqa","khewat","khatauni","landuse","remarks"];
  for(const k of commonKeys){
    const v = feature.getProperty(k);
    if(v != null && v !== "" && out[k] == null) out[k] = String(v);
  }

  // Always include khasra
  if(!out.khasra && !out.khasra_no) out.khasra = khasra;

  // Add geometry info (optional)
  out._vertices = String(countVertices(feature));

  // Render rows (show ALL cols if details exist, else show minimum)
  const keys = Object.keys(out);
  if(!keys.length){
    addKV("khasra", khasra || "—");
    addKV("note", "No details loaded for this khasra. Load CSV to show owner/area etc.");
  }else{
    // Put khasra first
    const ordered = [];
    if(out.khasra != null) ordered.push("khasra");
    if(out.khasra_no != null) ordered.push("khasra_no");
    // add common keys next
    for(const k of ["owner","area","village","tehsil","district","halqa","khewat","khatauni","landuse","remarks"]){
      if(k in out && !ordered.includes(k)) ordered.push(k);
    }
    // add rest
    for(const k of keys){
      if(!ordered.includes(k)) ordered.push(k);
    }

    for(const k of ordered){
      addKV(k, out[k]);
    }
  }

  function addKV(k, v){
    const row = document.createElement("div");
    row.className = "kvRow";
    const kk = document.createElement("div");
    kk.className = "k";
    kk.textContent = k;
    const vv = document.createElement("div");
    vv.className = "v";
    vv.textContent = (v ?? "").toString() || "—";
    row.appendChild(kk); row.appendChild(vv);
    kv.appendChild(row);
  }
}

function countVertices(feature){
  let count = 0;
  feature.getGeometry().forEachLatLng(() => count++);
  return count;
}
</script>

<!-- Google Maps JS API (YOU MUST PUT YOUR KEY) -->
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCuaKwWIV-Mtff4WwXnmAdAGVnL508G6RI&callback=initMap">
</script>

</body>
</html>